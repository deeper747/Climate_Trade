---
title: "Export"
output: html_document
date: "2025-12-10"
---

```{r}
# Install packages once if needed:
# install.packages(c("tidyverse", "sf", "rnaturalearth", "rnaturalearthdata", "wbstats", "readr"))
# install.packages("leaflet")   # if you donâ€™t have it yet

library(tidyverse)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(wbstats)
library(leaflet)
library(sf)
library(dplyr)
library(readr)
```

```{r}
#-----------------------------
# 1. Choose indicator & year
#-----------------------------

indicator_code <- "NE.EXP.GNFS.ZS"   # Exports of goods and services (% of GDP)
year_to_plot   <- 2023               # Change this to whatever year you want

#-----------------------------
# 2. Pull data from World Bank
#-----------------------------

wb_df <- wb_data(
  indicator   = indicator_code,
  start_date  = year_to_plot,
  end_date    = year_to_plot,
  return_wide = TRUE
)

# Keep only real countries (those with ISO3 codes)
wb_clean <- wb_df %>%
  filter(!is.na(iso3c)) %>%                      # drop non-countries
  select(
    iso3  = iso3c,
    country,
    export_pct = all_of(indicator_code)
  )
```

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  dplyr::transmute(
    name_long,
    iso3 = wb_a3,   # World Bank-compatible ISO3 codes
    geometry
  )

world_joined <- world %>%
  left_join(wb_clean, by = "iso3")
```


```{r}

# 1) Reproject to WGS84 for Leaflet
world_leaf <- st_transform(world_joined, crs = 4326)

# 2) Define a color palette (Blues here, but you can swap)
pal <- colorNumeric(
  palette = "Greens",                      # change palette here if you like
  domain  = world_leaf$export_pct,
  na.color = "transparent"
)

# 3) Create labels for hover
labels <- sprintf(
  "<strong>%s</strong><br/>Exports: %s %% of GDP",
  world_leaf$name_long,
  ifelse(is.na(world_leaf$export_pct), "N/A",
         round(world_leaf$export_pct, 1))
) %>% lapply(htmltools::HTML)

# 4) Build interactive map
leaflet(world_leaf) %>%
  addTiles() %>%
  addPolygons(
    fillColor   = ~pal(export_pct),
    weight      = 0.4,
    color       = "white",
    fillOpacity = 0.8,
    smoothFactor = 0.2,
    label       = labels,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    pal    = pal,
    values = ~export_pct,
    title  = "Exports (% of GDP)",
    opacity = 0.8
  )

```

```{r}
wb_dw <- wb_clean %>%
  filter(!is.na(export_pct)) %>%
  transmute(
    ISO3  = iso3,                   # Datawrapper can match this
    NAME  = country,                # optional but nice to keep
    VALUE = round(export_pct, 1)
  )


head(wb_dw)

# 3) Export to data/processed as CSV
output_path <- "data/processed/wb_exports_2023_datawrapper.csv"
write_csv(wb_dw, output_path)
```

